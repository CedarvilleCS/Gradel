{% block head %}
	<title>Gradel {% if problem != null %} | {{problem.assignment.name}} {% endif %}</title>
	<link rel="icon" type="image/x-icon" href="{{ asset('logo1.png') }}" />
{% endblock %}

{% block body %}

<body>
    {{ include('template/top-nav.html.twig') }}

	{# left panel with the problem links #}
	{{ include('template/problem-nav.html.twig') }}

	{{ include('template/path-nav.html.twig') }}
	
    <section id="main">

		{% if problem.assignment.problems|length == 0 %}

		{% else %}

			<div class="card">
				<h2 style="margin: 0px">{{problem.name}}</h2>
				{% set grade = grader.getProblemGrade(app.user, problem) %}
					
				{% if grade['total_testcases'] + grade['total_extra_testcases'] == grade['passed_testcases'] + grade['passed_extra_testcases'] %}
					<h3 style="color: green"> You have completed this problem! </h3>
				{% elseif grade['total_testcases'] == grade['passed_testcases'] %}
					<h3> Your solution has solved the normal testcases, but not the extra credit ones </h3>
				{% endif %}
				<h3>
					{% if attempts_remaining < 0 %}
						Unlimited attempts allowed
					{% else %}
						Attempts left: {{attempts_remaining}}
					{% endif %}


					{% if best_submission != null %}
						<a href="{{path('problem_result', {'submission_id': best_submission.id})}}"> [Currently accepted submission] </a>
					{% else %}
						<a> [You have no submissions yet] </a>
					{% endif %}
				</h3>
				<div id="courseInfo" class="card-contents">
					<p>{{problemDescription|nl2br}}</p>

					{# the ACE editor text area #}
					<div id="editor">{% if last_submission != null %}{{ last_submission.deblobinateSubmittedFile()|nl2br }}{% endif %}</div>
					<br/>

					{# display the form or not #}
					{% set open = (problem.assignment.start_time|date('U') < "now"|date('U') and problem.assignment.cutoff_time|date('U') > "now"|date('U')) %}

					{% if usersectionrole.role.role_name == 'Takes' and open and attempts_remaining != 0%}

						{# file upload#}
						<form id="submissionUploadForm" action="{{path('get_contents')}}" method="post">
							<input type="file" name="file" id="file" value="Upload File">
						</form>

						{# Language selection and hidden field to submit ACE contents #}
						<div id="submissionForm">

							Language:
							<select id="languageSelect" name="language">
								{% for lang in languages %}
									{% if lang.name != "No Language Restriction" %}
										<option value={{lang.id}}>{{lang.name}}</option>
									{% endif %}
								{% endfor %}
							</select>
							<br>
							<div id="mainClassInput" style="display:none"><label for="main_class">Main Class: </label><input type="text" name="main_class" id="main_class_input"></div>
							<div id="packgNameInput" style="display:none"><label for="package_name">Package Name: </label><input type="text" name="package_name" id="package_name_input"></div>
							<br/>
							<input type="hidden" name="ACE" id="ACE">
							<div class="btn" style="width: 100px" id="submissionButton"> Submit </div>
							<div id="loading-container" style="display: none">
								<img id="loadingGif" style="height: 60px" src="{{asset('beoload.gif')}}" alt="Loading..."/>
								<h3 style="margin: 0px"> Submitting Code... </h3>
							</div>
						</div>

					{% elseif attempts_remaining == 0 %}
						You are out of attempts for this problem.
					{% elseif open %}
						You are not "Taking" this class, so you cannot submit a problem.
					{% else %}
						This problem is not currently open.
					{% endif %}
				</div>
        </div>

		{% endif %}

    </section>
</body>
{% endblock %}


{% block stylesheets %}
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
	
    <link rel="stylesheet" href="{{ asset('styles.css') }}" />
    <link rel="stylesheet" href="{{ asset('card.css') }}" />
	
    <link rel="stylesheet" href="{{ asset('submit.css') }}" />

	<style>
		#submissionButton:hover {
			cursor:pointer;
		}
	</style>
{% endblock %}

{% block scripts %}
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="{{ asset('src-noconflict/ace.js') }}" type="text/javascript" charset="utf-8"></script>
	<script src="{{ asset('js/validation.js') }}"></script>
	<script>
		element = $("#main_class_input");
		$('#submissionButton').on('click', function(){          
			if ($.trim(element.val())  === '') {	
			setInvalid(element);
			}
		});
		
		/* Mark fields as valid once the user changes them */
		element.on('input',function(e){
			setValid(element);
		});
</script>

	{# asynchronous file upload #}
	<script src="http://malsup.github.com/jquery.form.js"></script>

	<script>
		var saved_code = "";

		function getLanguage(filename){

			var filetypes = JSON.parse('{{ filetypes|json_encode|raw }}');
			var ext = getExtension(filename);

			return filetypes[ext];
		}

		function getExtension(filename){

			var ext = filename.substr(filename.lastIndexOf('.') + 1);
			return ext;
		}

		function getName(filename){

			var ext = getExtension(filename);
			var cls = filename.substr(filename.lastIndexOf('\\') + 1).replace("."+ext,"");
			
			return cls;
		}

		function setLanguageFromFilename(filename){

			var classname = getName(filename);
			var ext = getExtension(filename);
			var language = getLanguage(filename);

			if(!language){
				language = $('#languageSelect option:selected').text();
			}

			setLanguage(language);

			// set the main class
			document.getElementById('main_class_input').value = classname;

			// toggle the java inputs
			toggleJavaInputs(language == "Java", ext == "zip");
		}

		function setLanguage(language){

			// set the language selector
			var selectObject = document.getElementById('languageSelect');
			for(var i=0; i<selectObject.length; i++){
				if(selectObject.options[i].text == language){
					selectObject.selectedIndex = i;
					break;
				}
			}

			var editor = ace.edit("editor");
			editor.$blockScrolling = Infinity;
			updateAceCode();

			// toggle the java inputs
			var ext = getExtension($('#submissionUploadForm #file').val());
			toggleJavaInputs(language == "Java", ext == "zip");
		}

		function toggleJavaInputs(state1, state2){

			if(!state1){
				document.getElementById('mainClassInput').style.display = 'none';
				document.getElementById('packgNameInput').style.display = 'none';
			} else if(state1 && !state2){
				document.getElementById('mainClassInput').style.display = 'block';
				document.getElementById('packgNameInput').style.display = 'none';
			} else{
				document.getElementById('mainClassInput').style.display = 'block';
				document.getElementById('packgNameInput').style.display = 'block';
			}
		}

		function updateAceCode(){

			var default_code = JSON.parse('{{ default_code|json_encode|replace({'\\':'\\\\'})|raw }}');
			var ace_modes = JSON.parse('{{ ace_modes|json_encode|raw }}');

			var editor = ace.edit("editor");
			editor.$blockScrolling = Infinity;
			
			language = $('#languageSelect option:selected').text();
			
			if(saved_code !== editor.getValue()) {
				editor.setValue(editor.getValue(), -1);
			} else {
				// This sets the default code for the selected language.
				editor.setValue(default_code[language], -1);
				saved_code = default_code[language];
			}
			editor.getSession().setMode("ace/mode/" + ace_modes[language]);
		}

	</script>

	<script>
		$(document).ready(function() {

				var editor = ace.edit("editor");
				editor.$blockScrolling = Infinity;

			// make the language dropdown change affect the code
			$('#languageSelect').change( function(data) {

				var language = $('#languageSelect option:selected').text();
				setLanguage(language);
			});

			// submit the form if the file upload is changed
			$('#submissionUploadForm #file').change( function(data) {
				$('#submissionUploadForm').submit();
			});

			// overwrite the normal submit to call the ajaxsubmit
			$('#submissionUploadForm').submit(function() {
				$(this).ajaxSubmit();
			});

			// asynchronous script to handle the submission form upload
			$('#submissionUploadForm').ajaxForm(function(data) {
				//console.log(data);
				setLanguageFromFilename(data["file"]);
				
				var editor = ace.edit("editor");
				editor.$blockScrolling = Infinity;
				editor.setValue(atob(data["contents"]));
				
				updateAceCode();
			});

			$('#submissionButton').click( function() {

				// Create a FormData object
				var formData = new FormData();

				// validate that fields are filled in
				var language = $('#languageSelect option:selected').val();
				var languageText = $('#languageSelect option:selected').text();
				var main_class = $('#main_class_input').val();
				var package_name = $('#package_name_input').val();

				if(languageText == 'Java' && main_class == '') {
					return false;
				} else if(languageText != 'Java'){

					main_class = "";
					package_name = "";
				}

				var editor = ace.edit("editor");
				editor.$blockScrolling = Infinity;				
				$("#ACE").val(editor.getValue());

				var ACE = $('#ACE').val();

				formData.append('language', language);
				formData.append('main_class', main_class);
				formData.append('package_name', package_name);
				formData.append('ACE', ACE);


				if(getExtension($('#submissionUploadForm #file').val()) == "zip"){

					var file = $('#submissionUploadForm #file').prop('files')[0];

					if(file){
						formData.append('file', file);
					}
				}

				$('#loading-container').show();
				$('#submissionButton').hide();
				
				$.ajax({
					type: "POST",
					url: "{{path('submission_upload', {'problem_id': problem.id}) }}",
					data: formData,
					processData: false,
					contentType: false,
					success: function(data){

						console.log(data);
						
						if(data['data'] != null){
							submitSolution(data['data']);
						} else {
							window.location = data["redirect_url"]
						}
					},
					error: function(data){
						alert(data['responseText']);
					}
				});

			});

			// set default stuff for the ace editor
			var editor = ace.edit("editor");
			editor.$blockScrolling = Infinity;
			editor.setTheme("ace/theme/xcode");
			
			{% if last_submission != null %}
			setLanguageFromFilename("{{last_submission.filename}}");
			{% else %}
			$('#languageSelect').change();			
			{% endif %}
		});
		
		
		function submitSolution(params){
			
			var submitData = {};
			
			submitData["problemId"] = params['problem_id'];
			submitData["languageId"] = params['language_id'];
			submitData["filename"] = params['submitted_filename'];
			submitData["mainclass"] = params['main_class'];
			submitData["packagename"] = params['package_name'];
				
			$.ajax({
				type: 'POST',
				url: "{{path('submit')}}",
				data: submitData,
				success: function(data) {				
					console.log(data);				
					window.location = data["redirect_url"];				
				},
				error: function(data) {
					alert(data['responseText']);
					
					$('#loading-container').hide();
					$('#submissionButton').show();
				},
				async: true
			});
			
		}
	</script>

{% endblock %}
