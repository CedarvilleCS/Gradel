{% block head %}
<title>Gradel</title>
<link rel="icon" type="image/x-icon" href="{{ asset('logo1.png') }}" />
{% endblock %}


{% block body %}

<body>
    {{ include('template/top-nav.html.twig') }}


    {# Left Nav #}
    <nav class="nav-left">
        <div onclick="newProb()" class="btn btn-center">Save</div>
    </nav>

    {# Main section #}

    <div class="scrollbar-macosx">
        <section id="main">
			{{ include('template/path-nav.html.twig') }}

            {# Cards #}
                    <div class="card">
            <table>
                <tr>
                    <th colspan="3">
                        <label for="name">Name</label>
                        <input id="name" name="name" type="text" value="">
                    </th>
                </tr>
                <tr>
                    <th colspan="3">
                        <label for="description">Description</label>
                        <input id="description" name="description" type="text">
                    </th>
                </tr>
                <th colspan="1.5">
                    <label for="languages">Languages</label>
                    <select id="languages" onchange="languageSelect()" name="languages" type="text">
                      <option></option>
                      {% for language in languages %}
                        <option value="{{language.id}}">{{language.name}}</option>
                      {% endfor %}
                    </select>
                    <div id="language-list">
                    </div>
                </th>
                <th colspan="1.5">
                    <label for="gm">Grading Method</label>
                    <select id="gm" onchange="" name="gm" type="text">
                      {% for gm in gradingMethods %}
                        <option value="{{gm.id}}">Total Attempts: {{gm.total_attempts}} Attempts Before Penalty: {{gm.attempts_before_penalty}}</option>
                      {% endfor %}
                    </select>
                    <div id="language-list">
                    </div>
                </th>
                <tr>
                        <th colspan="1">
                            <label for="weight">Weight</label>
                            <input id="weight" name="weight" type="text" value="1">
                        </th>

                        <th colspan="1">
                            <label for="time_limit">Time Limit</label>
              							<input type="text" id="time_limit" value="1000 ">
                        </th>
                        <th colspan="1">
                            <label for="extra-credit">Is Extra Credit</label>
                            <input id="extra-credit" type="checkbox" name="extra-credit" value="extra-credit">
                        </th>
                    </tr>

    					<tr>
    						<th colspan="3">
                  <button class="btn btn-center" id="add-test">Add Test Case Manually</button></br>
    							<button class="btn btn-center" id="add-test-file">Add Test Case By File</button>
                </th>
              </tr>

            </table>
        </div>


        	</div>
        </section>
    </div>


</body>

{% endblock %}


{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('styles.css') }}" />
    <link rel="stylesheet" href="{{ asset('home.css') }}" />
{% endblock %}


{% block scripts %}
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="{{ asset('js/cards.js') }}"></script>
	<script src="{{ asset('js/newSection.js') }}"></script>
	<script>
    var languages = [];
		testCases = 0;
		$("#add-test").click(function () {
			testCases++;
			div_name ="testcases"+testCases;
			formalName="Test Case "+testCases;
			newTestCard = `<div class="card">
				<div class="btn-close" onclick="collapseCard(&quot;`+div_name+`&quot;)">
					<h2 style="margin: 0px">`+formalName+`<span style="float: right"><i class="fa fa-angle-down"></i></span></h2>
				</div>
				<div id=`+div_name+` class="test-case">
					<table>
						<tr>
							<th colspan="1">
								<label for="input">Input</label>
								<textarea rows="2" id="input" class="problem_creation" type="text" value=""></textarea>
							<th colspan="1">
								<label for="output">Output</label>
								<textarea rows="2" id="output" class="output problem_creation" type="text" value=""></textarea>
							<th colspan="2">
								<label for="weight">Weight</label>
								<input id="weight" name="weight" type="text"></th>
						</tr>
						<tr>
							<th colspan="3">
								<label>Short Feedback</label>
								<textarea rows="2" class="problem_creation" id="short_feedback" type="text" value=""></textarea></th>
						</tr>
            <tr>
							<th colspan="3">
								<label>Long Feedback</label>
								<textarea rows="2" class="problem_creation" id="long_feedback" type="text" value=""></textarea></th>
						</tr>
					</table>
				</div>
			</div>`;
			newTestCard = newTestCard.replace(new RegExp('\r?\n','g'), "");
			$("#main").append(newTestCard);
		});

		$("#add-test-file").click(function () {
			testCases++;
			div_name ="testcases"+testCases;
			formalName="Test Case "+testCases;
			newTestCard = `<div class="card">
				<div class="btn-close" onclick="collapseCard(&quot;`+div_name+`&quot;,)">
					<h2 style="margin: 0px">`+formalName+`<span style="float: right"><i class="fa fa-angle-down"></i></span></h2>
				</div>
				<div id=`+div_name+`x class="test-case">
					<table>
						<tr>
							<th colspan="1">
								<label for="input">Input</label>
								<input id="input" type="file" value=""></th>
							<th colspan="1">
								<label for="output">Output</label>
								<input id="output" type="file" value=""></th>
							<th colspan="2">
								<label for="weight">Weight</label>
								<input id="weight" name="weight" type="text"></th>
						</tr>
						<tr>
							<th colspan="1">
								<label>Feedback</label><textarea rows="2" id="feedback" class="problem_creation" type="text" value=""></textarea></th>
						</tr>
					</table>
				</div>
			</div>`;
			newTestCard = newTestCard.replace(new RegExp('\r?\n','g'), "");
			$("#main").append(newTestCard);
		});

    function languageSelect() {
      const language = document.getElementById('languages');

      languages.push(language.value);
      $('#language-list').append(
        "<div>" + language.options[language.selectedIndex].label + "</div>"
      );
      language.selectedIndex = 0;
      console.log(language.value);
      console.log(language.options[language.selectedIndex].label);
    }

		async function insertTestCase(divname, problemId) {

				const input = $("#"+divname).find("#"+"input").val();
				const output = $("#"+divname).find("#" + "output").val();
				const short_fb = $("#"+divname).find("#"+"short_feedback").val();
        const long_fb = $('#'+divname).find("#" + "long_feedback").val();
        const weight = $('#' + divname).find("#" + "weight").val();
				var path = "{{path('testcase_insert')}}";
        console.log("problemID", problemId);

        $.post(path, {
          "problemId": problemId,
          "short_response": short_fb,
          "long_response": long_fb,
          "output": output,
          "input": input,
          "weight": weight,
        }, (data) => {
          console.log("done!!");
          console.log(data);
        }, "json");
			}

		async function newProb(){
      console.log("Creating new prob");
      const name = document.getElementById('name').value;
      const description = document.getElementById('description').value;
      const weight = document.getElementById('weight').value;
      const gm = document.getElementById('gm').value;
      const timeLimit = document.getElementById('time_limit').value;
      const extraCredit = document.getElementById('extra-credit').checked;
      console.log(extraCredit);
			var path = "{{path('problem_insert')}}";
      var problemId = -1;
      await $.post(path, {
        "assignmentId": {{assignmentId}},
        "name": name,
        "description": description,
        "time_limit": timeLimit,
        "weight": weight,
        "languages": languages,
        "grading_method": gm,
        "is_extra_credit": extraCredit,
      }, (data) => {
        console.log(data);
        if (data.errors.length > 0) {
          errorMessage = "";
          for (error of data.errors) {
            errorMessage += (" - " + error + "\n");
          }
          alert(errorMessage);
        }
        problemId = data.problemId;
      }, "json");
      var tcs = document.getElementsByClassName("test-case");

      for (testcase of tcs) {
        await insertTestCase(testcase.id, problemId);
      }

      // insertTestCase("testcases1");
		}
	</script>
{% endblock %}
